/**
	OI hex map in SVG
	0.6.2:
	    - allow multiple callbacks to be added with .on()
	0.6.1:
		- bug fixes
	0.6.0:
		- change namespace
		- set padding
		- can provide function to updateColours()
 */
!function(t){var e=t.OI||{};e.ready||(e.ready=function(t){"loading"!=document.readyState?t():document.addEventListener("DOMContentLoaded",t)}),e.ajax||(e.ajax=function(t,e){e||(e={});var i=new XMLHttpRequest;return"responseType"in i&&e.dataType&&(i.responseType=e.dataType),i.open(e.method||"GET",t+(e.cache?"?"+Math.random():""),!0),i.onload=function(i){if(this.status>=200&&this.status<400){var s=this.response;"function"==typeof e.success&&e.success.call(e.this||this,s,{url:t,data:e,originalEvent:i})}else"function"==typeof e.error&&e.error.call(e.this||this,i,{url:t,data:e})},"function"==typeof e.error&&(i.onerror=function(i){e.error.call(e.this||this,i,{url:t,data:e})}),i.send(),this}),e.hexmap=function(t,o){this.version="0.6.2",o||(o={}),this._attr=o,this.title="OI HexMap",this.logging=location.search.indexOf("debug=true")>=0;var l=new function(t){return t||(t={}),t.title||(t.title="Log"),t.version||(t.version="2.0"),this.message=function(...e){var i=e.shift();"string"!=typeof i&&(i="log");var s=["%c"+t.title+" "+t.version+"%c"];e.length>0&&(s[0]+=":","string"==typeof e[0]&&(s[0]+=" "+e.shift())),s.push("font-weight:bold;"),s.push(""),e.length>0&&(s=s.concat(e)),console[i].apply(null,s)},this}({title:"OI HexMap",version:this.version});if(this.log=l.message,!t)return this.log("warn","No DOM element to add to"),this;o.label||(o.label={}),o.grid||(o.grid={}),"boolean"!=typeof o.label.show&&(o.label.show=!1),"boolean"!=typeof o.label.clip&&(o.label.clip=!1),"boolean"!=typeof o.grid.show&&(o.grid.show=!1);var p=o.width||t.offsetWidth||300,c=o.height||t.offsetHeight||150;this.maxw=p,this.maxh=c;var d,f=p/c,u=!1,g={},m=parseFloat(getComputedStyle(t)["font-size"])||16;for(var y in this.areas={},this.padding="number"==typeof o.padding?o.padding:0,this.properties={size:o.size},this.callback={},this.mapping={},t.querySelector(".hexmap-inner")||(this.el=document.createElement("div"),this.el.classList.add("hexmap-inner"),t.appendChild(this.el)),this.options={clip:o.label.clip,showgrid:o.grid.show,showlabel:o.label.show,formatLabel:"function"==typeof o.label.format?o.label.format:function(t,e){return t.substr(0,3)},minFontSize:"number"==typeof o.minFontSize?o.minFontSize:4},this.style={default:{fill:"#cccccc","fill-opacity":1,"font-size":m,"stroke-width":1.5,"stroke-opacity":1,stroke:"#ffffff"},highlight:{fill:"#1DD3A7"},grid:{fill:"#aaa","fill-opacity":.1}},o.style)o.style[y]&&(this.style[y]||(this.style[y]={}),o.style[y].fill&&(this.style[y].fill=o.style[y].fill),o.style[y]["fill-opacity"]&&(this.style[y]["fill-opacity"]=o.style[y]["fill-opacity"]),o.style[y]["font-size"]&&(this.style[y]["font-size"]=o.style[y]["font-size"]),o.style[y].stroke&&(this.style[y].stroke=o.style[y].stroke),o.style[y]["stroke-width"]&&(this.style[y]["stroke-width"]=o.style[y]["stroke-width"]),o.style[y]["stroke-opacity"]&&(this.style[y]["stroke-opacity"]=o.style[y]["stroke-opacity"]));this.setHexSize=function(t){return"number"!=typeof t&&(t=10),t=Math.round(100*t)/100,o.size=t,this.properties.size=t,this},this.load=function(t,i,s){function a(t,e){x.setMapping(t),e&&x.updateColours(),"function"==typeof s&&s.call(x,{data:i})}return"function"!=typeof i||s||(s=i,i=""),"string"==typeof t?e.ajax(t,{this:this,dataType:"json",success:function(t){a(t)},error:function(e,i){this.log("error","Unable to load "+t,i)}}):"object"==typeof t&&a(t,!0),this},this.addHexes=function(t,e,i){if(this.mapping.layout)if(console.log(e),t.layout==this.mapping.layout){for(var s in t.hexes)this.mapping.hexes[s]=t.hexes[s];t=this.mapping}else this.log("warn","Layout has changed so over-writing existing hexes.");this.load(t,e,i)};var x=this;return window.addEventListener("resize",function(t){x.size()}),this.setHexStyle=function(t){var e,i,s,h;if(e=this.areas[t],i=a(this.style.default),s="",e.active&&(i.fill=e.fillcolour),e.hover&&(s+=" hover"),e.selected){for(h in this.style.selected)this.style.selected[h]&&(i[h]=this.style.selected[h]);s+=" selected"}return this.mapping.hexes[t].class&&(s+=" "+this.mapping.hexes[t].class),i.class="hex-cell"+s,r(e.hex,i),e.label&&r(e.label,{class:"hex-label"+s}),e},this.toFront=function(t){if(this.areas[t]){for(var e in this.areas)this.areas[e]&&(this.areas[e].selected&&s(this.areas[e].g,d),this.options.clip&&(i=this.areas[e],h=void 0,a=getComputedStyle(i.hex),h={},a.transform&&(h.transform=a.transform),"none"==h.transform&&(h.transform=""),a["transform-origin"]&&(h["transform-origin"]=a["transform-origin"]),r(i.clip,h)));s(this.areas[t].g,d)}var i,a,h;return this},this.regionToggleSelected=function(t,e){var i,s;if(this.selected=this.selected==t?"":t,(s=this.areas[t]).selected=!s.selected,this.setHexStyle(t),!s.selected&&e)for(i in this.areas)this.areas[i].selected&&(this.areas[i].selected=!1,this.setHexStyle(i));return this},this.regionFocus=function(t){return this.areas[t].hover=!0,this.el.querySelectorAll(".hover").forEach(function(t){t.classList.remove("hover")}),this.setHexStyle(t),this.toFront(t),this},this.regionBlur=function(t){return this.areas[t].hover=!1,this.setHexStyle(t),this},this.regionActivate=function(t){this.areas[t].active=!0,this.setHexStyle(t)},this.regionDeactivate=function(t){this.areas[t].active=!1,this.setHexStyle(t)},this.regionToggleActive=function(t){this.areas[t].active=!this.areas[t].active,this.setHexStyle(t)},this.selectRegion=function(t){for(var e in this.selected=t,this.areas)this.areas[e]&&(t.length>0&&0==e.indexOf(t)?(this.areas[e].selected=!0,this.setHexStyle(e)):(this.areas[e].selected=!1,this.setHexStyle(e)));return this},this.on=function(t,e,i){return"function"!=typeof e||i||(i=e,e=""),"function"!=typeof i?this:(this.callback||(this.callback={}),this.callback[t]||(this.callback[t]=[]),this.callback[t].push({fn:i,attr:e}),this)},this.size=function(e,a){this.el.style.height="",this.el.style.width="",r(t,{style:""}),d&&r(d,{width:0,height:0}),e=Math.min(this.maxw,t.offsetWidth),this.el.style.height=e/f+"px",this.el.style.width=e+"px",a=Math.min(this.maxh,this.el.offsetHeight),d||(r(d=h("svg"),{class:"hexmap-map",xmlns:i,version:"1.1",overflow:"visible",viewBox:o.viewBox||"0 0 "+e+" "+a,style:"max-width:100%;",preserveAspectRatio:"xMinYMin meet","vector-effect":"non-scaling-stroke"}),s(d,this.el)),r(d,{width:e,height:a});var n=e/p;return this.properties.size=o.size*n,p=e,c=a,this.el.style.height="",this.el.style.width="",this},this.initialized=function(){this.create().draw();var e=t.querySelector(".spinner");return e&&e.parentNode.removeChild(e),this},this.create=function(){return d.innerHTML="",this.areas={},this.grid&&this.grid.remove(),delete this.grid,u=!1,this},this.setMapping=function(t){var e;return this.mapping=t,this.properties||(this.properties={x:100,y:100}),e=t.layout.split("-"),this.properties.shift=e[0],this.properties.orientation=e[1],this.updateRange(),this.initialized()},this.updateRange=function(){var t,e,i,s,r;for(t in g={r:{min:1/0,max:-1/0},q:{min:1/0,max:-1/0}},this.mapping.hexes)this.mapping.hexes[t]&&(s=(e=this.mapping.hexes[t]).q,r=e.r,"odd-r"==this.mapping.layout&&e.r%2==1&&(s+=.5),"even-r"==this.mapping.layout&&e.r%2==0&&(s+=.5),"odd-q"==this.mapping.layout&&e.q%2==1&&(r+=.5),"even-q"==this.mapping.layout&&e.q%2==0&&(r+=.5),s>g.q.max&&(g.q.max=s),s<g.q.min&&(g.q.min=s),r>g.r.max&&(g.r.max=r),r<g.r.min&&(g.r.min=r));return g.q.min-=this.padding,g.q.max+=this.padding,g.r.min-=this.padding,g.r.max+=this.padding,g.q.d=g.q.max-g.q.min,g.r.d=g.r.max-g.r.min,g.q.mid=g.q.min+g.q.d/2,g.r.mid=g.r.min+g.r.d/2,this.range=a(g),i="r"==this.properties.orientation?Math.min(.5*c/(.75*g.r.d+1),1/Math.sqrt(3)*p/(g.q.d+1)):Math.min(1/Math.sqrt(3)*c/(g.r.d+1),.5*p/(.75*g.q.d+1)),"number"!=typeof o.size&&this.setHexSize(i),this.setSize(),this},this.setSize=function(t){return t&&(this.properties.size=t),this.properties.s={cos:Math.round(10*this.properties.size*Math.sqrt(3)/2)/10,sin:.5*this.properties.size},this.properties.s.c=this.properties.s.cos.toFixed(2),this.properties.s.s=this.properties.s.sin.toFixed(2),this},this.drawHex=function(t,e){var i,s,a,r,h,n;return this.properties?(a=this.properties.s.cos,r=this.properties.s.sin,n=function(t,e,i){return"odd-r"==i&&e%2!=0&&(t+=.5),"even-r"==i&&e%2==0&&(t+=.5),"odd-q"==i&&t%2!=0&&(e+=.5),"even-q"==i&&t%2==0&&(e+=.5),{q:t,r:e}}(t,e,this.mapping.layout),"r"==this.properties.orientation?(i=p/2+(n.q-this.range.q.mid)*a*2,s=c/2-(n.r-this.range.r.mid)*r*3):(i=p/2+(n.q-this.range.q.mid)*r*3,s=c/2-(n.r-this.range.r.mid)*a*2),h=[["M",[i=parseFloat(i.toFixed(1)),s]]],"r"==this.properties.orientation?(h.push(["m",[a,-r]]),h.push(["l",[0,2*r,-a,r,-a,-r,0,-2*r,a,-r,a,r]]),h.push(["z",[]])):(h.push(["m",[-r,a]]),h.push(["l",[2*r,0,r,-a,-r,-a,-2*r,0,-r,a]]),h.push(["z",[]])),{array:h,path:function(t){for(var e="",i=0;i<t.length;i++)e+=(t[i][0]?t[i][0]:" ")+(t[i][1].length>0?t[i][1].join(","):" ");return e}(h),x:i,y:s}):this},this.updateColours=function(t){var e;for(e in"function"!=typeof t&&(t=function(){var t=this.style.default.fill;return x.mapping.hexes[e].colour&&(t=x.mapping.hexes[e].colour),"string"==typeof o.colours&&(t=o.colours),t}),this.mapping.hexes)this.mapping.hexes[e]&&(this.areas[e].fillcolour=t.call(this,e),this.setHexStyle(e));return this},this.draw=function(){var e,i,a,o;this.updateRange();var l=this.range;function p(t,e){var i=[];if(t.data.hexmap.callback[e])for(var s=0;s<t.data.hexmap.callback[e].length;s++){for(var a in t.data.hexmap.callback[e][s].attr)t.data.hexmap.callback[e][s].attr[a]&&(t.data[a]=t.data.hexmap.callback[e][s].attr[a]);"function"==typeof t.data.hexmap.callback[e][s].fn&&i.push(t.data.hexmap.callback[e][s].fn.call(t.data.this||this,t))}return i||!1}var c,f,g,m,y,x,v=function(t){t.data.region&&t.data.hexmap.regionFocus(t.data.region),p(t,"mouseover")},b=function(t){p(t,"mouseout")},w=function(t){t.data.region&&t.data.hexmap.regionFocus(t.data.region),p(t,"click")};if((this.options.showgrid||this.options.clip)&&!this.grid){for(this.grid=h("g"),r(this.grid,{class:"hex-grid-holder"}),i=l.q.min-1;i<=l.q.max+1;i++)for(e=l.r.min-1;e<=l.r.max+1;e++)a=this.drawHex(i,e),this.options.showgrid&&(r(o=h("path"),{d:a.path,class:"hex-grid","data-q":i||"0","data-r":e||"0",fill:this.style.grid.fill||"","fill-opacity":this.style.grid["fill-opacity"]||.1,stroke:this.style.grid.stroke||"#aaa","stroke-opacity":this.style.grid["stroke-opacity"]||.2}),s(o,this.grid),n("mouseover",o,{type:"grid",hexmap:this,data:{r:e,q:i}},v),n("mouseout",o,{type:"grid",hexmap:this,me:c,data:{r:e,q:i}},b),n("click",o,{type:"grid",hexmap:this,me:c,data:{r:e,q:i}},w));s(this.grid,d)}for(e in c=this,s(f=h("defs"),d),t.getAttribute("id"),this.mapping.hexes)this.mapping.hexes[e]&&(a=this.drawHex(this.mapping.hexes[e].q,this.mapping.hexes[e].r),u||(r(x=h("g"),{data:e}),d.appendChild(x),(g=h("path")).innerHTML="<title>"+(this.mapping.hexes[e].n||e)+"</title>",r(g,{d:a.path,class:"hex-cell","transform-origin":a.x+"px "+a.y+"px","data-q":this.mapping.hexes[e].q,"data-r":this.mapping.hexes[e].r}),x.appendChild(g),this.areas[e]={g:x,hex:g,selected:!1,active:!0,data:this.mapping.hexes[e],orig:a},n("mouseover",x,{type:"hex",hexmap:this,region:e,data:this.mapping.hexes[e],pop:this.mapping.hexes[e].p},v),n("mouseout",x,{type:"hex",hexmap:this,region:e,me:this.areas[e]},b),n("click",x,{type:"hex",hexmap:this,region:e,me:this.areas[e],data:this.mapping.hexes[e]},w),this.options.showlabel&&this.style.default["font-size"]>=this.options.minFontSize&&(this.options.clip&&(this.areas[e].clipid=(t.getAttribute("id")||"hex")+"-clip-"+e,this.areas[e].clip=h("clipPath"),this.areas[e].clip.setAttribute("id",this.areas[e].clipid),r(y=h("path"),{d:a.path,"transform-origin":a.x+"px "+a.y+"px"}),s(y,this.areas[e].clip),s(this.areas[e].clip,f)),m=h("text"),x.appendChild(m),m.innerHTML=this.options.formatLabel(this.mapping.hexes[e].n||this.mapping.hexes[e].msoa_name_hcl,{x:a.x,y:a.y,hex:this.mapping.hexes[e],size:this.properties.size,"font-size":parseFloat(getComputedStyle(m)["font-size"])}),r(m,{x:a.x,y:a.y,"transform-origin":a.x+"px "+a.y+"px","dominant-baseline":"central","clip-path":"url(#"+this.areas[e].clipid+")","data-q":this.mapping.hexes[e].q,"data-r":this.mapping.hexes[e].r,class:"hex-label","text-anchor":"middle","font-size":this.style.default["font-size"]+"px",title:this.mapping.hexes[e].n||e,_region:e}),this.areas[e].label=m,this.areas[e].labelprops={x:a.x,y:a.y})),this.setHexStyle(e),r(this.areas[e].hex,{stroke:this.style.default.stroke,"stroke-opacity":this.style.default["stroke-opacity"],"stroke-width":this.style.default["stroke-width"],title:this.mapping.hexes[e].n,"data-regions":e,style:"cursor: pointer;"}));return u=!0,this},this.size(),o.hexjson&&this.load(o.hexjson,o.ready),this};var i="http://www.w3.org/2000/svg";function s(t,e){return e.appendChild(t)}function a(t){return JSON.parse(JSON.stringify(t))}function r(t,e){for(var i in e)e[i]&&t.setAttribute(i,e[i]);return t}function h(t){return document.createElementNS(i,t)}function n(t,e,i,s){e&&(e.length||(e=[e]),"function"==typeof s&&e.forEach(function(e){e.addEventListener(t,function(t){t.data=i,s.call(i.this||this,t)})}))}t.OI=e}(window||this);